<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python 实践网页报告生成与邮件分发 | 隶笔难书</title>
<meta name=keywords content="Python"><meta name=description content="项目背景
在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：long_screenshot.py 和 send_email.py，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。"><meta name=author content><link rel=canonical href=https://waite.wang/posts/python/web-report-generation-and-email-distribution/><link crossorigin=anonymous href=/assets/css/stylesheet.1f25c954b6964bfd120383618e0c76f5d98627118274109d51919206cab78c1e.css integrity="sha256-HyXJVLaWS/0SA4Nhjgx29dmGJxGCdBCdUZGSBsq3jB4=" rel="preload stylesheet" as=style><link rel=icon href=https://waite.wang/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://waite.wang/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://waite.wang/favicon-32x32.png><link rel=apple-touch-icon href=https://waite.wang/apple-touch-icon.png><link rel=mask-icon href=https://waite.wang/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://waite.wang/posts/python/web-report-generation-and-email-distribution/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://waite.wang/posts/python/web-report-generation-and-email-distribution/"><meta property="og:site_name" content="隶笔难书"><meta property="og:title" content="Python 实践网页报告生成与邮件分发"><meta property="og:description" content="项目背景 在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：long_screenshot.py 和 send_email.py，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-07T16:04:23+08:00"><meta property="article:modified_time" content="2025-05-07T16:04:23+08:00"><meta property="article:tag" content="Python"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 实践网页报告生成与邮件分发"><meta name=twitter:description content="项目背景
在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：long_screenshot.py 和 send_email.py，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://waite.wang/posts/"},{"@type":"ListItem","position":2,"name":"Python 实践网页报告生成与邮件分发","item":"https://waite.wang/posts/python/web-report-generation-and-email-distribution/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python 实践网页报告生成与邮件分发","name":"Python 实践网页报告生成与邮件分发","description":"项目背景 在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：long_screenshot.py 和 send_email.py，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。\n","keywords":["Python"],"articleBody":"项目背景 在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：long_screenshot.py 和 send_email.py，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。\n工具模块介绍 1. 网页长截图模块 (long_screenshot.py) 该模块使用 playwright 和 img2pdf 实现网页长截图并生成 PDF 文件。\n核心功能： 支持自定义设备模拟（如 iPhone 15） 异步实现，适合与异步框架集成 自动计算页面实际高度 生成高质量 PDF 文件 关键代码分析： async def take_long_screenshot(url: str, output_path: str = \"output.pdf\", device_name: str = \"iPhone 15\") -\u003e None: # 使用异步上下文管理器启动 playwright async with async_playwright() as p: # 启动无头浏览器（headless=True 表示不显示浏览器界面） browser = await p.chromium.launch(headless=True) # 获取设备配置（如 iPhone 15 的屏幕尺寸、UA 等） device = p.devices[device_name] # 创建新的浏览器上下文，应用设备配置 context = await browser.new_context(**device) # 创建新页面 page = await context.new_page() try: # 访问目标 URL，等待网络请求完成 await page.goto(url, wait_until=\"networkidle\") # 等待 2 秒，确保页面完全加载 await page.wait_for_timeout(2000) # 计算页面实际高度 # 1. 设置页面溢出为可见 # 2. 遍历所有元素，找出最底部的位置 # 3. 返回实际高度 real_height = await page.evaluate(\"\"\"() =\u003e { document.body.style.overflow = 'visible'; document.documentElement.style.overflow = 'visible'; const elements = document.getElementsByTagName('*'); let maxHeight = 0; for (let element of elements) { const rect = element.getBoundingClientRect(); maxHeight = Math.max(maxHeight, rect.bottom); } return Math.ceil(maxHeight); }\"\"\") # 设置视口大小，确保能完整显示页面 await page.set_viewport_size({ \"width\": device[\"viewport\"][\"width\"], \"height\": real_height }) # 等待 10 秒，确保动态内容加载完成 await page.wait_for_timeout(10000) # 截取整个页面 screenshot = await page.screenshot( full_page=True, type=\"png\", clip={ \"x\": 0, \"y\": 0, \"width\": device[\"viewport\"][\"width\"], \"height\": real_height } ) # 将截图转换为 PDF with open(output_path, \"wb\") as pdf_file: pdf_file.write(img2pdf.convert(screenshot)) except Exception as e: print(f\"截图失败: {str(e)}\") raise finally: # 确保浏览器关闭，释放资源 await browser.close() 性能优化建议： 调整等待时间：\n# 根据页面复杂度调整等待时间 await page.wait_for_timeout(2000) # 基础等待 await page.wait_for_timeout(10000) # 动态内容等待 使用选择器等待：\n# 等待特定元素加载完成 await page.wait_for_selector('.report-content', timeout=30000) 优化内存使用：\n# 分块处理大页面 chunk_height = 1000 for y in range(0, real_height, chunk_height): screenshot = await page.screenshot( clip={ \"x\": 0, \"y\": y, \"width\": device[\"viewport\"][\"width\"], \"height\": min(chunk_height, real_height - y) } ) 2. 邮件发送模块 (send_email.py) 该模块实现了邮件发送功能，支持同步和异步两种方式，并支持带 PDF 附件的邮件发送。\n核心功能： 支持 HTML 格式邮件内容 自动添加签名和退订信息 支持 PDF 附件 异步发送支持回调通知 关键代码分析： def _create_email_message( message: str, Subject: str, sender_show: str, recipient_show: str, to_addrs: str, cc_show: str = '', pdf_path: str = 'output.pdf' ) -\u003e MIMEMultipart: # 创建邮件容器 msg = MIMEMultipart('alternative') # 设置邮件头 msg['Message-ID'] = email.utils.make_msgid() msg['Date'] = email.utils.formatdate(time.time(), True) msg['From'] = email.utils.formataddr((str(Header(sender_show, 'utf-8')), user)) msg['To'] = email.utils.formataddr((str(Header(recipient_show, 'utf-8')), to_addrs)) msg['Subject'] = Header(Subject, 'utf-8') # 添加邮件内容 html_content = f\"\"\" {message} {footer} \"\"\" msg.attach(MIMEText(html_content, 'html', 'utf-8')) # 添加 PDF 附件 try: with open(pdf_path, 'rb') as pdf_file: pdf_attachment = MIMEApplication(pdf_file.read(), _subtype='pdf') pdf_attachment.add_header('Content-Disposition', 'attachment', filename=('utf-8', '', '名书报告.pdf')) msg.attach(pdf_attachment) except FileNotFoundError: print(f\"Warning: {pdf_path} not found, sending email without attachment\") return msg def _send_email_worker( msg: MIMEMultipart, to_addrs: str, callback: Optional[Callable[[bool, Optional[Exception]], None]] = None ) -\u003e None: try: # 使用 SSL 连接 SMTP 服务器 with SMTP_SSL(host=config.EMAIL_SMTP_HOST, port=config.EMAIL_SMTP_PORT) as smtp: # 登录 smtp.login(user=config.EMAIL_USER, password=config.EMAIL_PASSWORD) # 发送邮件 smtp.sendmail( from_addr=config.EMAIL_USER, to_addrs=[addr.strip() for addr in to_addrs.split(',')], msg=msg.as_string() ) print(\"Email sent successfully\") if callback: callback(True, None) except Exception as e: print(f\"Failed to send email: {e}\") if callback: callback(False, e) raise 实际使用示例： # 同步发送邮件 def send_report_sync(report_url: str, recipient_email: str): try: # 生成 PDF pdf_path = \"report.pdf\" asyncio.run(take_long_screenshot(report_url, pdf_path)) # 发送邮件 message = \"\"\" 您的报告已生成 请查看附件获取详细报告。\n\"\"\" sendMail( message=message, Subject=\"您的报告\", sender_show=\"系统\", recipient_show=\"用户\", to_addrs=recipient_email, pdf_path=pdf_path ) except Exception as e: print(f\"发送失败: {e}\") # 处理错误... # 异步发送邮件 def send_report_async(report_url: str, recipient_email: str): async def generate_report(): pdf_path = \"report.pdf\" await take_long_screenshot(report_url, pdf_path) return pdf_path def on_email_sent(success: bool, error: Optional[Exception]): if success: print(\"邮件发送成功\") else: print(f\"邮件发送失败: {error}\") # 使用 asyncio 运行异步任务 pdf_path = asyncio.run(generate_report()) # 异步发送邮件 sendMailAsync( message=\"您的报告已生成\", Subject=\"您的报告\", sender_show=\"系统\", recipient_show=\"用户\", to_addrs=recipient_email, pdf_path=pdf_path, callback=on_email_sent ) 配置说明 邮件配置 (config.py) # 邮件服务器配置 EMAIL_USER = \"your_email@example.com\" EMAIL_PASSWORD = \"your_password\" EMAIL_SMTP_HOST = \"smtp.example.com\" EMAIL_SMTP_PORT = 465 # 可选：配置重试机制 EMAIL_MAX_RETRIES = 3 EMAIL_RETRY_DELAY = 5 # 秒 依赖安装 # 安装必要的包 pip install playwright img2pdf # 安装浏览器驱动 playwright install chromium 总结与最佳实践 技术要点：\n使用 playwright 实现高质量网页截图 异步处理提高系统性能 模块化设计便于维护和扩展 最佳实践：\n合理设置超时时间 添加错误处理和日志记录 使用配置文件管理敏感信息 考虑邮件发送频率限制 注意事项：\n确保 SMTP 服务器配置正确 注意网页加载时间 处理大文件时的内存占用 常见问题解答 Q: 如何处理网页加载超时？ A: 调整 wait_for_timeout 参数，或使用 wait_for_selector 等待特定元素。\nQ: 邮件发送失败如何处理？ A: 使用回调函数捕获异常，实现重试机制。\nQ: 如何优化大文件处理？ A: 考虑使用流式处理或分块上传。\n参考资料 Playwright 官方文档 img2pdf 文档 Python SMTP 文档 ","wordCount":"1732","inLanguage":"zh-cn","datePublished":"2025-05-07T16:04:23+08:00","dateModified":"2025-05-07T16:04:23+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://waite.wang/posts/python/web-report-generation-and-email-distribution/"},"publisher":{"@type":"Organization","name":"隶笔难书","logo":{"@type":"ImageObject","url":"https://waite.wang/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://waite.wang/ accesskey=h title="隶笔难书 (Alt + H)">隶笔难书</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://waite.wang/ title=首页><span>首页</span></a></li><li><a href=https://waite.wang/search title=搜索><span>搜索</span></a></li><li><a href=https://waite.wang/categories title=分类><span>分类</span></a></li><li><a href=https://waite.wang/tags title=标签><span>标签</span></a></li><li><a href=https://waite.wang/archives title=归档><span>归档</span></a></li><li><a href=https://waite.wang/links title=友链><span>友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Python 实践网页报告生成与邮件分发</h1><div class=post-meta>Created: &nbsp;<span title='2025-05-07 16:04:23 +0800 +0800'>2025-05-07</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;1732 words&nbsp;|&nbsp;<a href=https://github.com/Waite0603/HugoBlog/edit/main/content/posts/python/web-report-generation-and-email-distribution.md rel="noopener noreferrer" target=_blank>在 GitHub 编辑</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e9%a1%b9%e7%9b%ae%e8%83%8c%e6%99%af aria-label=项目背景>项目背景</a></li><li><a href=#%e5%b7%a5%e5%85%b7%e6%a8%a1%e5%9d%97%e4%bb%8b%e7%bb%8d aria-label=工具模块介绍>工具模块介绍</a><ul><li><a href=#1-%e7%bd%91%e9%a1%b5%e9%95%bf%e6%88%aa%e5%9b%be%e6%a8%a1%e5%9d%97-long_screenshotpy aria-label="1. 网页长截图模块 (long_screenshot.py)">1. 网页长截图模块 (<code>long_screenshot.py</code>)</a><ul><li><a href=#%e6%a0%b8%e5%bf%83%e5%8a%9f%e8%83%bd aria-label=核心功能：>核心功能：</a></li><li><a href=#%e5%85%b3%e9%94%ae%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90 aria-label=关键代码分析：>关键代码分析：</a></li><li><a href=#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e5%bb%ba%e8%ae%ae aria-label=性能优化建议：>性能优化建议：</a></li></ul></li><li><a href=#2-%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81%e6%a8%a1%e5%9d%97-send_emailpy aria-label="2. 邮件发送模块 (send_email.py)">2. 邮件发送模块 (<code>send_email.py</code>)</a><ul><li><a href=#%e6%a0%b8%e5%bf%83%e5%8a%9f%e8%83%bd-1 aria-label=核心功能：>核心功能：</a></li><li><a href=#%e5%85%b3%e9%94%ae%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90-1 aria-label=关键代码分析：>关键代码分析：</a></li><li><a href=#%e5%ae%9e%e9%99%85%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=实际使用示例：>实际使用示例：</a></li></ul></li></ul></li><li><a href=#%e9%85%8d%e7%bd%ae%e8%af%b4%e6%98%8e aria-label=配置说明>配置说明</a><ul><li><a href=#%e9%82%ae%e4%bb%b6%e9%85%8d%e7%bd%ae-configpy aria-label="邮件配置 (config.py)">邮件配置 (<code>config.py</code>)</a></li><li><a href=#%e4%be%9d%e8%b5%96%e5%ae%89%e8%a3%85 aria-label=依赖安装>依赖安装</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label=总结与最佳实践>总结与最佳实践</a></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e8%a7%a3%e7%ad%94 aria-label=常见问题解答>常见问题解答</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=项目背景>项目背景<a hidden class=anchor aria-hidden=true href=#项目背景>#</a></h2><p>在现代化应用中，自动化报告生成和邮件分发是常见的需求。本文将介绍两个 Python 工具模块：<code>long_screenshot.py</code> 和 <code>send_email.py</code>，它们分别负责网页长截图和邮件发送功能，可以协同工作，实现从网页截图到邮件分发的完整流程。</p><h2 id=工具模块介绍>工具模块介绍<a hidden class=anchor aria-hidden=true href=#工具模块介绍>#</a></h2><h3 id=1-网页长截图模块-long_screenshotpy>1. 网页长截图模块 (<code>long_screenshot.py</code>)<a hidden class=anchor aria-hidden=true href=#1-网页长截图模块-long_screenshotpy>#</a></h3><p>该模块使用 <code>playwright</code> 和 <code>img2pdf</code> 实现网页长截图并生成 PDF 文件。</p><h4 id=核心功能>核心功能：<a hidden class=anchor aria-hidden=true href=#核心功能>#</a></h4><ul><li>支持自定义设备模拟（如 iPhone 15）</li><li>异步实现，适合与异步框架集成</li><li>自动计算页面实际高度</li><li>生成高质量 PDF 文件</li></ul><h4 id=关键代码分析>关键代码分析：<a hidden class=anchor aria-hidden=true href=#关键代码分析>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>take_long_screenshot</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>output_path</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;output.pdf&#34;</span><span class=p>,</span> <span class=n>device_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;iPhone 15&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用异步上下文管理器启动 playwright</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>async_playwright</span><span class=p>()</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 启动无头浏览器（headless=True 表示不显示浏览器界面）</span>
</span></span><span class=line><span class=cl>        <span class=n>browser</span> <span class=o>=</span> <span class=k>await</span> <span class=n>p</span><span class=o>.</span><span class=n>chromium</span><span class=o>.</span><span class=n>launch</span><span class=p>(</span><span class=n>headless</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取设备配置（如 iPhone 15 的屏幕尺寸、UA 等）</span>
</span></span><span class=line><span class=cl>        <span class=n>device</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>devices</span><span class=p>[</span><span class=n>device_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 创建新的浏览器上下文，应用设备配置</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=k>await</span> <span class=n>browser</span><span class=o>.</span><span class=n>new_context</span><span class=p>(</span><span class=o>**</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 创建新页面</span>
</span></span><span class=line><span class=cl>        <span class=n>page</span> <span class=o>=</span> <span class=k>await</span> <span class=n>context</span><span class=o>.</span><span class=n>new_page</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 访问目标 URL，等待网络请求完成</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>goto</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>wait_until</span><span class=o>=</span><span class=s2>&#34;networkidle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 等待 2 秒，确保页面完全加载</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>wait_for_timeout</span><span class=p>(</span><span class=mi>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 计算页面实际高度</span>
</span></span><span class=line><span class=cl>            <span class=c1># 1. 设置页面溢出为可见</span>
</span></span><span class=line><span class=cl>            <span class=c1># 2. 遍历所有元素，找出最底部的位置</span>
</span></span><span class=line><span class=cl>            <span class=c1># 3. 返回实际高度</span>
</span></span><span class=line><span class=cl>            <span class=n>real_height</span> <span class=o>=</span> <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;() =&gt; {
</span></span></span><span class=line><span class=cl><span class=s2>                document.body.style.overflow = &#39;visible&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>                document.documentElement.style.overflow = &#39;visible&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>                const elements = document.getElementsByTagName(&#39;*&#39;);
</span></span></span><span class=line><span class=cl><span class=s2>                let maxHeight = 0;
</span></span></span><span class=line><span class=cl><span class=s2>                for (let element of elements) {
</span></span></span><span class=line><span class=cl><span class=s2>                    const rect = element.getBoundingClientRect();
</span></span></span><span class=line><span class=cl><span class=s2>                    maxHeight = Math.max(maxHeight, rect.bottom);
</span></span></span><span class=line><span class=cl><span class=s2>                }
</span></span></span><span class=line><span class=cl><span class=s2>                return Math.ceil(maxHeight);
</span></span></span><span class=line><span class=cl><span class=s2>            }&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 设置视口大小，确保能完整显示页面</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>set_viewport_size</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;width&#34;</span><span class=p>:</span> <span class=n>device</span><span class=p>[</span><span class=s2>&#34;viewport&#34;</span><span class=p>][</span><span class=s2>&#34;width&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;height&#34;</span><span class=p>:</span> <span class=n>real_height</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 等待 10 秒，确保动态内容加载完成</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>wait_for_timeout</span><span class=p>(</span><span class=mi>10000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 截取整个页面</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>screenshot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>full_page</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;png&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>clip</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;x&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;y&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;width&#34;</span><span class=p>:</span> <span class=n>device</span><span class=p>[</span><span class=s2>&#34;viewport&#34;</span><span class=p>][</span><span class=s2>&#34;width&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;height&#34;</span><span class=p>:</span> <span class=n>real_height</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 将截图转换为 PDF</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_path</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>pdf_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pdf_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>img2pdf</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=n>screenshot</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;截图失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 确保浏览器关闭，释放资源</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>browser</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=性能优化建议>性能优化建议：<a hidden class=anchor aria-hidden=true href=#性能优化建议>#</a></h4><ol><li><p>调整等待时间：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 根据页面复杂度调整等待时间</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>wait_for_timeout</span><span class=p>(</span><span class=mi>2000</span><span class=p>)</span>  <span class=c1># 基础等待</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>wait_for_timeout</span><span class=p>(</span><span class=mi>10000</span><span class=p>)</span>  <span class=c1># 动态内容等待</span>
</span></span></code></pre></div></li><li><p>使用选择器等待：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 等待特定元素加载完成</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>wait_for_selector</span><span class=p>(</span><span class=s1>&#39;.report-content&#39;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>30000</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>优化内存使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 分块处理大页面</span>
</span></span><span class=line><span class=cl><span class=n>chunk_height</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>real_height</span><span class=p>,</span> <span class=n>chunk_height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>screenshot</span> <span class=o>=</span> <span class=k>await</span> <span class=n>page</span><span class=o>.</span><span class=n>screenshot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>clip</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;x&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;y&#34;</span><span class=p>:</span> <span class=n>y</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;width&#34;</span><span class=p>:</span> <span class=n>device</span><span class=p>[</span><span class=s2>&#34;viewport&#34;</span><span class=p>][</span><span class=s2>&#34;width&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;height&#34;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>chunk_height</span><span class=p>,</span> <span class=n>real_height</span> <span class=o>-</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div></li></ol><h3 id=2-邮件发送模块-send_emailpy>2. 邮件发送模块 (<code>send_email.py</code>)<a hidden class=anchor aria-hidden=true href=#2-邮件发送模块-send_emailpy>#</a></h3><p>该模块实现了邮件发送功能，支持同步和异步两种方式，并支持带 PDF 附件的邮件发送。</p><h4 id=核心功能-1>核心功能：<a hidden class=anchor aria-hidden=true href=#核心功能-1>#</a></h4><ul><li>支持 HTML 格式邮件内容</li><li>自动添加签名和退订信息</li><li>支持 PDF 附件</li><li>异步发送支持回调通知</li></ul><h4 id=关键代码分析-1>关键代码分析：<a hidden class=anchor aria-hidden=true href=#关键代码分析-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_create_email_message</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Subject</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sender_show</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>recipient_show</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>to_addrs</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>cc_show</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pdf_path</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;output.pdf&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MIMEMultipart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建邮件容器</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=n>MIMEMultipart</span><span class=p>(</span><span class=s1>&#39;alternative&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 设置邮件头</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;Message-ID&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>make_msgid</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;Date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>formatdate</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>formataddr</span><span class=p>((</span><span class=nb>str</span><span class=p>(</span><span class=n>Header</span><span class=p>(</span><span class=n>sender_show</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>)),</span> <span class=n>user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;To&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>formataddr</span><span class=p>((</span><span class=nb>str</span><span class=p>(</span><span class=n>Header</span><span class=p>(</span><span class=n>recipient_show</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>)),</span> <span class=n>to_addrs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;Subject&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Header</span><span class=p>(</span><span class=n>Subject</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 添加邮件内容</span>
</span></span><span class=line><span class=cl>    <span class=n>html_content</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        </span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        </span><span class=si>{</span><span class=n>footer</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=s2>    &lt;/html&gt;
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>MIMEText</span><span class=p>(</span><span class=n>html_content</span><span class=p>,</span> <span class=s1>&#39;html&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 添加 PDF 附件</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>pdf_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>pdf_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pdf_attachment</span> <span class=o>=</span> <span class=n>MIMEApplication</span><span class=p>(</span><span class=n>pdf_file</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span> <span class=n>_subtype</span><span class=o>=</span><span class=s1>&#39;pdf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pdf_attachment</span><span class=o>.</span><span class=n>add_header</span><span class=p>(</span><span class=s1>&#39;Content-Disposition&#39;</span><span class=p>,</span> <span class=s1>&#39;attachment&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>filename</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;名书报告.pdf&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>pdf_attachment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Warning: </span><span class=si>{</span><span class=n>pdf_path</span><span class=si>}</span><span class=s2> not found, sending email without attachment&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>msg</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_send_email_worker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=p>:</span> <span class=n>MIMEMultipart</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>to_addrs</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Callable</span><span class=p>[[</span><span class=nb>bool</span><span class=p>,</span> <span class=n>Optional</span><span class=p>[</span><span class=ne>Exception</span><span class=p>]],</span> <span class=kc>None</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 SSL 连接 SMTP 服务器</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>SMTP_SSL</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>EMAIL_SMTP_HOST</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>EMAIL_SMTP_PORT</span><span class=p>)</span> <span class=k>as</span> <span class=n>smtp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 登录</span>
</span></span><span class=line><span class=cl>            <span class=n>smtp</span><span class=o>.</span><span class=n>login</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>EMAIL_USER</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>EMAIL_PASSWORD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 发送邮件</span>
</span></span><span class=line><span class=cl>            <span class=n>smtp</span><span class=o>.</span><span class=n>sendmail</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>from_addr</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>EMAIL_USER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>to_addrs</span><span class=o>=</span><span class=p>[</span><span class=n>addr</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>addr</span> <span class=ow>in</span> <span class=n>to_addrs</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span><span class=o>=</span><span class=n>msg</span><span class=o>.</span><span class=n>as_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Email sent successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>callback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>callback</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to send email: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>callback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=p>(</span><span class=kc>False</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span></code></pre></div><h4 id=实际使用示例>实际使用示例：<a hidden class=anchor aria-hidden=true href=#实际使用示例>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 同步发送邮件</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_report_sync</span><span class=p>(</span><span class=n>report_url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>recipient_email</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 生成 PDF</span>
</span></span><span class=line><span class=cl>        <span class=n>pdf_path</span> <span class=o>=</span> <span class=s2>&#34;report.pdf&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>take_long_screenshot</span><span class=p>(</span><span class=n>report_url</span><span class=p>,</span> <span class=n>pdf_path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 发送邮件</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;h3&gt;您的报告已生成&lt;/h3&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;p&gt;请查看附件获取详细报告。&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendMail</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Subject</span><span class=o>=</span><span class=s2>&#34;您的报告&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>sender_show</span><span class=o>=</span><span class=s2>&#34;系统&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>recipient_show</span><span class=o>=</span><span class=s2>&#34;用户&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>to_addrs</span><span class=o>=</span><span class=n>recipient_email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pdf_path</span><span class=o>=</span><span class=n>pdf_path</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;发送失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 处理错误...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 异步发送邮件</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_report_async</span><span class=p>(</span><span class=n>report_url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>recipient_email</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>generate_report</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>pdf_path</span> <span class=o>=</span> <span class=s2>&#34;report.pdf&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>take_long_screenshot</span><span class=p>(</span><span class=n>report_url</span><span class=p>,</span> <span class=n>pdf_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pdf_path</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_email_sent</span><span class=p>(</span><span class=n>success</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=ne>Exception</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;邮件发送成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;邮件发送失败: </span><span class=si>{</span><span class=n>error</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 使用 asyncio 运行异步任务</span>
</span></span><span class=line><span class=cl>    <span class=n>pdf_path</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>generate_report</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 异步发送邮件</span>
</span></span><span class=line><span class=cl>    <span class=n>sendMailAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=o>=</span><span class=s2>&#34;&lt;h3&gt;您的报告已生成&lt;/h3&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Subject</span><span class=o>=</span><span class=s2>&#34;您的报告&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sender_show</span><span class=o>=</span><span class=s2>&#34;系统&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>recipient_show</span><span class=o>=</span><span class=s2>&#34;用户&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>to_addrs</span><span class=o>=</span><span class=n>recipient_email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pdf_path</span><span class=o>=</span><span class=n>pdf_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>callback</span><span class=o>=</span><span class=n>on_email_sent</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><h2 id=配置说明>配置说明<a hidden class=anchor aria-hidden=true href=#配置说明>#</a></h2><h3 id=邮件配置-configpy>邮件配置 (<code>config.py</code>)<a hidden class=anchor aria-hidden=true href=#邮件配置-configpy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 邮件服务器配置</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_USER</span> <span class=o>=</span> <span class=s2>&#34;your_email@example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_PASSWORD</span> <span class=o>=</span> <span class=s2>&#34;your_password&#34;</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_SMTP_HOST</span> <span class=o>=</span> <span class=s2>&#34;smtp.example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_SMTP_PORT</span> <span class=o>=</span> <span class=mi>465</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可选：配置重试机制</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_MAX_RETRIES</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_RETRY_DELAY</span> <span class=o>=</span> <span class=mi>5</span>  <span class=c1># 秒</span>
</span></span></code></pre></div><h3 id=依赖安装>依赖安装<a hidden class=anchor aria-hidden=true href=#依赖安装>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装必要的包</span>
</span></span><span class=line><span class=cl>pip install playwright img2pdf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装浏览器驱动</span>
</span></span><span class=line><span class=cl>playwright install chromium
</span></span></code></pre></div><h2 id=总结与最佳实践>总结与最佳实践<a hidden class=anchor aria-hidden=true href=#总结与最佳实践>#</a></h2><ol><li><p>技术要点：</p><ul><li>使用 <code>playwright</code> 实现高质量网页截图</li><li>异步处理提高系统性能</li><li>模块化设计便于维护和扩展</li></ul></li><li><p>最佳实践：</p><ul><li>合理设置超时时间</li><li>添加错误处理和日志记录</li><li>使用配置文件管理敏感信息</li><li>考虑邮件发送频率限制</li></ul></li><li><p>注意事项：</p><ul><li>确保 SMTP 服务器配置正确</li><li>注意网页加载时间</li><li>处理大文件时的内存占用</li></ul></li></ol><h2 id=常见问题解答>常见问题解答<a hidden class=anchor aria-hidden=true href=#常见问题解答>#</a></h2><ol><li><p>Q: 如何处理网页加载超时？
A: 调整 <code>wait_for_timeout</code> 参数，或使用 <code>wait_for_selector</code> 等待特定元素。</p></li><li><p>Q: 邮件发送失败如何处理？
A: 使用回调函数捕获异常，实现重试机制。</p></li><li><p>Q: 如何优化大文件处理？
A: 考虑使用流式处理或分块上传。</p></li></ol><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ul><li><a href=https://playwright.dev/python/ target=_blank>Playwright 官方文档</a></li><li><a href=https://pypi.org/project/img2pdf/ target=_blank>img2pdf 文档</a></li><li><a href=https://docs.python.org/3/library/smtplib.html target=_blank>Python SMTP 文档</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://waite.wang/tags/python/>Python</a></li></ul><nav class=paginav><a class=next href=https://waite.wang/posts/ai/vue-and-flask-to-do-a-basic-llm-result-and-render/><span class=title>下一页 »</span><br><span>Vue+Flask实现一个最基础的LLM请求响应以及渲染</span></a></nav></footer><script src=https://utteranc.es/client.js repo=Waite0603/HugoBlog issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span><a href=https://beian.miit.gov.cn/ target=_blank rel="noopener noreferrer">粤ICP备2022028437号-1</a></span><br><span>Copyright &copy; 2018 - 2025 By <a href=https://waite.wang/>Waite</a>, All Rights
Reserved.</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=/js/jquery-3.5.1.min.js></script><link rel=stylesheet href=/css/jquery.fancybox.min.css><script src=/js/jquery.fancybox.min.js></script></body></html>